import { useQuery, useMutation } from 'convex/react';
import { api } from '../../../../convex/_generated/api';
import { useState } from 'react';
import { Effect, Schema } from 'effect';

// Local validation schema - mirrors api package but keeps web self-contained
const CreateMessageSchema = Schema.Struct({
  text: Schema.String.pipe(Schema.minLength(1)),
  author: Schema.String.pipe(Schema.minLength(1)),
});

// Message type for Convex query results
interface Message {
  _id: string;
  text: string;
  author: string;
  createdAt: number;
}

export function Home() {
  const [text, setText] = useState('');
  const [author, setAuthor] = useState('');

  // Convex queries and mutations
  const messages = useQuery(api.messages.list, { limit: 20 }) as Message[] | undefined;
  const sendMessage = useMutation(api.messages.send);
  const removeMessage = useMutation(api.messages.remove);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // Use Effect for validation
    const result = await Effect.runPromise(
      Schema.decodeUnknown(CreateMessageSchema)({ text, author })
    ).catch(() => null);

    if (result) {
      await sendMessage({ text: result.text, author: result.author });
      setText('');
    }
  };

  return (
    <div style={{ padding: '2rem', maxWidth: '800px', margin: '0 auto' }}>
      <h1><%= projectName %></h1>
      <p><%= description %></p>

      <div style={{ marginTop: '2rem' }}>
        <h2>Messages</h2>

        <form onSubmit={handleSubmit} style={{ marginBottom: '1rem' }}>
          <input
            type="text"
            value={author}
            onChange={(e) => setAuthor(e.target.value)}
            placeholder="Your name"
            style={{ padding: '0.5rem', marginRight: '0.5rem' }}
          />
          <input
            type="text"
            value={text}
            onChange={(e) => setText(e.target.value)}
            placeholder="Message..."
            style={{ padding: '0.5rem', width: '50%' }}
          />
          <button type="submit" style={{ padding: '0.5rem 1rem', marginLeft: '0.5rem' }}>
            Send
          </button>
        </form>

        {messages === undefined ? (
          <p>Loading...</p>
        ) : messages.length === 0 ? (
          <p>No messages yet. Send one!</p>
        ) : (
          <ul style={{ listStyle: 'none', padding: 0 }}>
            {messages.map((msg) => (
              <li
                key={msg._id}
                style={{
                  padding: '0.5rem',
                  borderBottom: '1px solid #eee',
                  display: 'flex',
                  justifyContent: 'space-between',
                }}
              >
                <span>
                  <strong>{msg.author}:</strong> {msg.text}
                  <small style={{ marginLeft: '1rem', color: '#666' }}>
                    {new Date(msg.createdAt).toLocaleTimeString()}
                  </small>
                </span>
                <button
                  onClick={() => removeMessage({ id: msg._id })}
                  style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'red' }}
                >
                  Ã—
                </button>
              </li>
            ))}
          </ul>
        )}
      </div>

      <div style={{ marginTop: '2rem', padding: '1rem', background: '#f5f5f5', borderRadius: '4px' }}>
        <h3>Tech Stack</h3>
        <ul>
          <li><strong>Effect-ts</strong> - Type-safe functional programming</li>
          <li><strong>Convex</strong> - Real-time database</li>
          <li><strong>TanStack Start</strong> - Type-safe full-stack routing</li>
          <li><strong>TanStack Query</strong> - Data fetching and caching</li>
        </ul>
      </div>
    </div>
  );
}
