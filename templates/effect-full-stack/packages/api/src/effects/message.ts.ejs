import { Context, Effect, Layer, Schema, ParseResult } from 'effect';

export const MessageSchema = Schema.Struct({
  _id: Schema.String,
  text: Schema.String,
  author: Schema.String,
  createdAt: Schema.Number,
});

export type Message = typeof MessageSchema.Type;

export const CreateMessageSchema = Schema.Struct({
  text: Schema.String.pipe(Schema.minLength(1)),
  author: Schema.String.pipe(Schema.minLength(1)),
});

export type CreateMessageInput = typeof CreateMessageSchema.Type;

export class MessageService extends Context.Tag('MessageService')<
  MessageService,
  {
    readonly validate: (input: unknown) => Effect.Effect<CreateMessageInput, ParseResult.ParseError>;
    readonly formatMessage: (message: Message) => Effect.Effect<string>;
  }
>() {}

export const MessageServiceLive = Layer.succeed(
  MessageService,
  MessageService.of({
    validate: (input) =>
      Schema.decodeUnknown(CreateMessageSchema)(input),

    formatMessage: (message) =>
      Effect.succeed(`[${new Date(message.createdAt).toISOString()}] ${message.author}: ${message.text}`),
  })
);
